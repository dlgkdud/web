<!DOCTYPE html>
<html>
<head>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    <style>
        .gridbox-container {
            display: grid;
            grid-template-columns: repeat(9, 70px);
          }

          .gridbox-container button {
            width: 70px;
            height: 70px;
            border: 1px solid rgba(0, 0, 0, 1);
            text-align: center;
            font-size: 1em;
          }
          
          .gridbox-item {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 1);
            padding: 1em;
            font-size: 1em;
            text-align: center;
            font-weight: bold;
          }

          .flagged {
            background-color: yellow;
            font-weight: bold;
            color: red;
          }

          .opened {
            background-color: #D3D3D3;
            font-weight: bold;
          }
          
          .input-item-decorator {
            color: rgba(136,137,220,1);
          }
          
          .fixed-item-decorator {
            color: rgba(0,0,0,1);
          }
          
          .cell-padding-left {
            margin-left: 0.2em;
          }
          
          .cell-padding-bottom {
            margin-bottom: 0.2em;
          }
          
          #main-flexbox{
            display: flex;
            flex-flow: column;
            align-items: center;
            height: 100%;
          }
          
          #content-flexbox{
            display: flex;
            flex: 1;
            width: 100%;
            flex-flow: row;
          }
          
          #dummy-flexbox {
            display: flex;
            flex: 2;
            flex-flow: column;
            justify-content: center;
            align-items: center;
          }
          
          #mine-flexbox {
            flex: 4;
            flex-flow: row;
            height: 100%;
          }
          
          #mine-flexbox > .gridbox-container{
            justify-content: center;
          }
          
          #button-flexbox {
            display: flex;
            flex: 2;
            flex-flow: column;
            align-items: center;
            justify-content: space-between;
            height: 100%;
          }
          
          .btn-primary, .btn-primary:hover, .btn-primary:active, .btn-primary:visited, .btn-primary:focus {
            width: 8em;
            background-color: rgba(200, 177, 232, 1);
            border-color: rgba(200, 177, 232, 1);
          }
          
          #submit-btn {
            margin-bottom: 2em;
          }
          
          #main-flexbox {
            margin-top: 1em;
          }
          
          #nav-bar-flexbox {
            margin-bottom: 1em;
          }
          
          #fail-toast {
            position: relative;
          }
    </style>
</head>
<body>

    <div id="main-flexbox">
        <div id="nav-bar-flexbox">
            <h3>WEB MINE!</h3>
        </div>
        <div id="content-flexbox">
            <div id="dummy-flexbox"></div>
            <div id="mine-flexbox">
                <div class="gridbox-container">
                </div>
            </div>
            <div id="button-flexbox">
                <div>
                    <a id="submit-btn" class="btn btn-primary" role="button">SUBMIT</a>
                </div>
                <div id="timer-box">
                    <h3>00:00:00</h3>
                </div>
            </div>
        </div>
        
        <div id="fail-toast-container" style="position: absolute; top: 40%;">
            <div id="fail-toast" class="toast">
                <div class="toast-header">
                    <strong class="mr-auto text-danger">제출한 답안이 틀렸습니다!</strong>
                </div>
                <div class="toast-body text-danger">
                    제출한 답안이 틀렸습니다!
                </div>
            </div>
        </div>

        <div id="success-toast-container" style="position: absolute; top: 40%;">
            <div id="success-toast" class="toast" data-autohide="false">
                <div class="toast-header">
                    <strong class="mr-auto text-primary">축하합니다!</strong>
                    <button type="button" class="ml-2 mb-1 close" data-dismiss="toast">&times;</button>
                </div>
                <div class="toast-body text-danger">
                    <div>
                        <strong class="mr-auto text-primary">축하합니다!</strong>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        axios.get('/mine/mine/make')
        .then(make_mine);
      
      let timer_textbox = document.querySelector("#timer-box > h3");
      var elapsed_time = 0;
      
      $('#success-toast-container').hide();
      $('#fail-toast-container').hide();
      
      let timer = setInterval(function(){
        elapsed_time+=1;
      
        let seconds = parseInt(elapsed_time%60);
        let minutes = parseInt((elapsed_time%3600)/60);
        let hours = parseInt(elapsed_time/3600);
      
        seconds = seconds.toString().padStart(2, '0');
        minutes = minutes.toString().padStart(2, '0');
        hours = hours.toString().padStart(2, '0');
      
        timer_textbox.innerText = `${hours}:${minutes}:${seconds}`;
      
      },1000);
      
      let button_flexbox = document.querySelector("#submit-btn");
      
      button_flexbox.addEventListener("click",function(){
        axios.post('/mine/mine/check',
                   get_mine_data()
                  ).then(process_result);
      });
      
      function get_mine_data() {
        let data = {
          'elapsed_time':elapsed_time,
        }
      
        let grid_container = document.querySelector(".gridbox-container");
        let board = [];
      
        for(let i=0;i<9;i++){
          for(let j=0;j<9;j++){
            let k = i*9 + j;
            let cell = grid_container.children[k];
            if(k%9==0){ 
              board.push([]);
            }
            board[i].push(Number(cell.innerText));
          }
        }
      
        data['puzzle'] = board;
      
        return data;
      }
      
      function process_result(response) {
        let status = response.data.status;
        clearInterval(timer);
      
        if(status == 'clear'){
          $('#success-toast-container').show();
          $('#success-toast').toast('show');
      
        }else{
          $('#fail-toast-container').show();
          $('#fail-toast').toast('show');
        }
      }
      
      function make_mine(response){
        let board = response.data.board;
        let grid_container = document.querySelector(".gridbox-container");
        grid_container.innerHTML = '';
        for(let i=0;i<9;i++){
          let row = document.createElement('div');
            for(let j=0;j<9;j++){
              let cell = document.createElement('button');
              // i, j 번째 행, 열 위치 지정
              cell.setAttribute('data-row', i);
              cell.setAttribute('data-col', j);
              // board 데이터 설정
              cell.setAttribute('mine', board[i][j]['mine']);
              cell.setAttribute('flag', board[i][j]['flag']);
              cell.setAttribute('open', board[i][j]['open']);
              cell.setAttribute('mine_count_around', board[i][j]['mine_count_around']);
              
              // 좌, 우클릭 event 함수 연결
              cell.addEventListener('click', onCellClick);
              cell.addEventListener('contextmenu', onCellRightClick);
              // 텍스트(테스트용) 표시
              if (board[i][j]['mine']) {
                cell.innerText = "💣";
              }
              else{
                cell.innerText = board[i][j]['mine_count_around'].toString();
              }
              
              
              cell.classList.add("gridbox-item");
              row.appendChild(cell);
              // 클릭 함수, 우클릭 함수 만들어서 연결하기
              // 지뢰 위치는 board에서 주니까 안해도 됨
            }
            grid_container.appendChild(row);
        }
    }
        // 셀 클릭 이벤트
        function onCellClick(event) {
          let cell = event.target;
          const row = parseInt(cell.getAttribute('data-row'));
          const col = parseInt(cell.getAttribute('data-col'));
          const mine = $.parseJSON(cell.getAttribute('mine'));
          const flag = $.parseJSON(cell.getAttribute('flag'));
          const open = $.parseJSON(cell.getAttribute('open'));
          
          if (flag){ return }
          if (open){ return }

          if (mine) {
            setTimeout(() => { // alert를 setTimeout 내에 넣어 화면 갱신을 허용한 후 메시지를 표시합니다.
            alert('그 칸은 지뢰입니다!');
            axios.get('/mine/mine/make')
            .then(make_mine);
            }, 50);
          } else {
              revealCell(row, col);
          }
      }

    // 클릭시 셀 열기
    function revealCell(row, col) {
      let grid_container = document.querySelector(".gridbox-container")
      let cell = grid_container.children[row].children[col];
      if ($.parseJSON(cell.getAttribute('open'))) return;

      cell.setAttribute('open', true)
      cell.classList.add('opened');
      cell.innerText = cell.getAttribute('mine_count_around');
      let mine_count_around = cell.getAttribute('mine_count_around');
      if (mine_count_around == 0) {
        if (row > 0){
          revealCell(row-1, col);
        }
        if (col > 0){
          revealCell(row, col-1);
        }
        if (row < 9-1){
          revealCell(row+1, col);
        }
        if (col < 9-1){
          revealCell(row, col+1);
        }
      }
    }


          // 오른쪽 클릭(깃발 설정 및 해제)
    function onCellRightClick(event) {
      event.preventDefault(); // 기본 오른쪽 클릭 메뉴를 나타나지 않게 합니다.
      const cell = event.target;
      
      const mine = $.parseJSON(cell.getAttribute('mine'));
      const flag = $.parseJSON(cell.getAttribute('flag'));
      const open = $.parseJSON(cell.getAttribute('open'));
      if (open) return; // 이미 클릭된 셀은 깃발 설정을 하지 않습니다.

      if (flag) {
        cell.setAttribute('flag', false);
        cell.classList.remove('flagged');
        cell.textContent = '';
      } else {
        cell.setAttribute('flag', true);
        cell.classList.add('flagged');
        cell.textContent = '🚩';
      }
  }
    </script>
</body>
</html>